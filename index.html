<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ToDo + Timeline (Web) ‚Äî mit Lineal</title>
  <style>
    :root{
      --bg:#fff;--text:#111;--muted:#666;--border:#ccc;--primary:#0a66c2;--danger:#c62828;--warn:#e69500;--ok:#2e7d32;
      --chip:#eee;--shadow:0 8px 24px rgba(0,0,0,.12)
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .app{max-width:920px;margin:60px auto 80px;padding:0 20px}
    .row{display:flex;gap:8px;align-items:center}
    .between{justify-content:space-between}
    .header{margin-bottom:16px}
    button{height:40px;padding:0 14px;border-radius:8px;border:1px solid var(--border);background:#f7f7f7;cursor:pointer}
    button.primary{background:var(--primary);color:#fff;border-color:transparent}
    button.warn{background:var(--warn);color:#fff;border-color:transparent}
    button.danger{background:var(--danger);color:#fff;border-color:transparent}
    button.ghost{background:transparent}
    button:disabled{opacity:.6;cursor:not-allowed}
    .chip{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    input,textarea,select{border:1px solid var(--border);border-radius:8px;padding:10px;background:#fff;color:inherit}
    input.compact{height:44px}
    textarea{resize:vertical}
    .section{margin:16px 0}
    .muted{color:var(--muted)}
    .coin{color:#e6c700;font-weight:700}
    .task{padding:12px 10px;border-bottom:1px solid #eee}
    .task .title{font-size:18px}
    .task.done .title{text-decoration:line-through;color:#777}
    .kbadge{display:inline-flex;gap:6px;align-items:center;margin-top:6px}
    .kbox{width:12px;height:12px;border-radius:3px;display:inline-block}
    .actions{display:flex;gap:6px}
    .subtasks{margin:6px 0 0 24px}
    .subrow{display:flex;justify-content:space-between;gap:8px;padding:4px 0}
    .progress{height:10px;background:#eee;border-radius:6px;overflow:hidden}
    .bar{height:10px;background:var(--ok)}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.grid{grid-template-columns:1fr auto auto}}
    dialog{border:none;border-radius:12px;box-shadow:var(--shadow);max-width:720px;width:clamp(320px,92vw,720px)}
    dialog::backdrop{background:rgba(0,0,0,.3)}
    .divider{height:1px;background:var(--border);margin:14px 0}
    .legend{display:flex;align-items:center;gap:8px}
    .legend .dot{width:14px;height:14px;border-radius:3px}
    .percentbar{display:flex;gap:0;height:22px;background:#eee;border-radius:6px;overflow:hidden}
    /* Neu: selektierte Priorit√§t */
    .prio-selected {
      border: 2px solid var(--primary);
      background: var(--primary) !important;
      color: #fff !important;
    }

    /* Lineal / Tagesansicht */
    .lineal-wrapper { width:420px; max-width:92vw; }
    .lineal-container {
      position:relative;
      border:1px solid var(--border);
      background:linear-gradient(#fff,#fbfbfb);
      height: 480px; /* sichtbarer Bereich (wird scrollbar) */
      overflow-y:auto;
      box-sizing:border-box;
      padding-left:56px; /* Platz f√ºr Zeitlabels */
    }
    .lineal-inner {
      position:relative;
      width:100%;
      box-sizing:border-box;
    }
    .hour-line {
      position:absolute;
      left:0;
      right:0;
      height:1px;
      background:#e6e6e6;
    }
    .hour-label {
      position:absolute;
      left:8px;
      transform:translateY(-50%);
      font-size:12px;
      color:var(--muted);
      width:48px;
      text-align:left;
    }
    .time-marker {
      position:absolute;
      left:0;
      right:0;
      height:4px;
      background:darkred;
      z-index:30;
      box-shadow:0 0 6px rgba(0,0,0,.25);
    }
    .lineal-block {
      position:absolute;
      left:64px;
      right:8px;
      border-radius:6px;
      padding:4px 6px;
      color:#fff;
      font-size:12px;
      box-sizing:border-box;
      z-index:20;
      overflow:hidden;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .lineal-timeline-block {
      position:absolute;
      left:8px;
      right:8px;
      border-radius:6px;
      padding:6px 8px;
      color:#fff;
      font-size:13px;
      box-sizing:border-box;
      z-index:18;
      background:#333;
      opacity:0.95;
      display:flex;
      align-items:center;
    }
    .lineal-empty {
      padding:20px;text-align:center;color:var(--muted);
    }

    /* kleine Buttons im Dialog */
    .lineal-controls { display:flex; gap:8px; align-items:center; margin-top:8px; justify-content:flex-end; }
    .small { height:36px; padding:0 10px; font-size:14px; border-radius:8px; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="row between header">
      <div class="row" style="gap:12px">
        <button id="btnSettings">‚öôÔ∏è Einstellungen</button>
        <button id="btnStats" class="ghost" title="Statistiken">üìä</button>
        <!-- Neu: Lineal Button -->
        <button id="btnLineal" class="ghost" title="Tagesansicht (Lineal)">üìè</button>
      </div>
      <div class="row">
        <span id="coinLabel" class="coin">üí∞ 0</span>
      </div>
    </header>

    <section class="section" id="addArea">
      <div id="collapsedAdd">
        <button id="btnShowAdd" class="primary">‚úö Neue Aufgabe</button>
      </div>
      <div id="expandedAdd" style="display:none" class="card">
        <!-- Grid: Task, Dauer, Kategorie (jetzt Dropdown) + Zeit -->
        <div class="grid">
          <input id="inpTask" class="compact" placeholder="Hauptaufgabe‚Ä¶" />
          <input id="inpDuration" class="compact" placeholder="Dauer (Min)" inputmode="numeric" />
          <!-- Kategorie: Dropdown mit Optionen + custom input (ausgeblendet standardm√§√üig) -->
          <div style="display:flex;gap:8px;align-items:center">
            <select id="inpCategory" class="compact" style="flex:1">
              <option value="">Kategorie w√§hlen‚Ä¶</option>
              <option value="Arbeit">Arbeit</option>
              <option value="Hobby">Hobby</option>
              <option value="Freizeit">Freizeit</option>
              <option value="Lernen">Lernen</option>
              <option value="Sport">Sport</option>
              <option value="Schlafen">Schlafen</option>
              <option value="custom">Eigene Eingabe‚Ä¶</option>
            </select>
            <input id="inpCategoryCustom" class="compact" placeholder="Eigene Kategorie" style="display:none;min-width:160px" />
          </div>
        </div>

        <!-- Neu: Eingabefeld f√ºr Startzeit (optional) -->
        <div class="grid" style="margin-top:8px;grid-template-columns:1fr auto">
          <input id="inpTime" type="time" class="compact" placeholder="Startzeit (optional)" />
          <div style="align-self:center" class="muted">optional</div>
        </div>

        <div id="prioRow" class="row" style="margin-top:8px">
          <button data-prio="hoch" class="warn">üî• Hoch</button>
          <button data-prio="mittel">üî∑ Mittel</button>
          <button data-prio="niedrig" class="">üçÉ Niedrig</button>
          <span id="prioSel" class="chip">aktuell: mittel</span>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnAdd" class="primary">Aufgabe hinzuf√ºgen</button>
          <button id="btnCancelAdd" class="danger">Abbrechen</button>
        </div>
      </div>
    </section>

    <section class="section row" id="aiArea" style="gap:8px">
      <button id="btnAIModal" class="primary">KI-Aufgaben hinzuf√ºgen</button>
      <span id="aiInfo" class="muted"></span>
    </section>

    <section class="section card" id="subtaskArea" style="display:none">
      <div class="row between">
        <strong>Unteraufgabe f√ºr: <span id="subtaskFor"></span></strong>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="inpSubtask" class="compact" placeholder="Unteraufgabe‚Ä¶" />
        <button id="btnAddSubtask">Hinzuf√ºgen</button>
      </div>
    </section>

    <section class="section card" id="listArea">
      <div id="todoList"></div>
    </section>

    <section class="section card" id="timelineArea" style="display:none">
      <strong>‚è±Ô∏è Timeline</strong>
      <div id="timelineList" style="margin-top:8px"></div>
      <div class="row" style="margin-top:10px;gap:8px">
        <button id="btnToggleTimeline">‚ñ∂Ô∏è Start</button>
        <button id="btnClearTimeline" class="danger">üóëÔ∏è Leeren</button>
      </div>
    </section>
  </div>

  <!-- Einstellungen -->
  <dialog id="dlgSettings">
    <form method="dialog" class="card" style="border:none;box-shadow:none">
      <h3 style="margin:0 0 10px">Einstellungen</h3>
      <div class="row between">
        <label>Priorit√§ten-Feature</label>
        <input type="checkbox" id="swPrio">
      </div>
      <div class="row between" style="margin-top:10px">
        <label>Zeitleisten-Feature</label>
        <input type="checkbox" id="swTimeline">
      </div>
      <div class="row between" style="margin-top:10px">
        <label>KI-Aufgaben-Feature</label>
        <input type="checkbox" id="swAI">
      </div>

      <div class="divider"></div>

      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button id="btnExport" class="ok">üíæ Daten exportieren</button>
        <button id="btnImport" class="warn">üì• Daten importieren</button>
        <button id="btnBuyCoins">100 Coins kaufen (Demo)</button>
      </div>

      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="btnCloseSettings" class="danger">Schlie√üen</button>
      </div>
    </form>
  </dialog>

  <!-- KI Aufgaben -->
  <dialog id="dlgAI">
    <form method="dialog" class="card" style="border:none;box-shadow:none">
      <h3 style="margin:0 0 10px">KI-Aufgaben generieren</h3>
      <textarea id="aiPrompt" placeholder="Beschreibe deine Aufgaben‚Ä¶" rows="6"></textarea>
      <details style="margin:8px 0">
        <summary>OpenAI-Einstellungen</summary>
        <div class="row" style="margin-top:8px">
          <input id="aiKey" placeholder="OpenAI API-Key (wird nicht gespeichert)" style="width:100%">
        </div>
        <div class="row" style="margin-top:6px;gap:8px">
          <label>Modell</label>
          <select id="aiModel">
            <option value="gpt-4o-mini">gpt-4o-mini</option>
            <option value="gpt-4o-mini-2024-07-18">gpt-4o-mini-2024-07-18</option>
            <option value="gpt-4o">gpt-4o</option>
          </select>
        </div>
      </details>
      <div class="row" style="gap:8px;margin-top:8px">
        <button id="btnGenAI" class="primary">Generieren</button>
        <button id="btnCloseAI" class="danger">Abbrechen</button>
        <span id="aiBusy" class="muted" style="margin-left:auto"></span>
      </div>
    </form>
  </dialog>

  <!-- KI Unteraufgaben -->
  <dialog id="dlgSubAI">
    <form method="dialog" class="card" style="border:none;box-shadow:none">
      <h3 style="margin:0 0 10px">KI-Unteraufgaben generieren</h3>
      <div class="muted" style="margin-bottom:6px">Hauptaufgabe:</div>
      <div style="font-weight:600;margin-bottom:8px" id="subAITitle"></div>
      <textarea id="subAIPrompt" placeholder="Optional: zus√§tzliche Hinweise‚Ä¶" rows="4"></textarea>
      <details style="margin:8px 0">
        <summary>OpenAI-Einstellungen</summary>
        <div class="row" style="margin-top:8px">
          <input id="subAIKey" placeholder="OpenAI API-Key (wird nicht gespeichert)" style="width:100%">
        </div>
        <div class="row" style="margin-top:6px;gap:8px">
          <label>Modell</label>
          <select id="subAIModel">
            <option value="gpt-4o-mini">gpt-4o-mini</option>
            <option value="gpt-4o-mini-2024-07-18">gpt-4o-mini-2024-07-18</option>
            <option value="gpt-4o">gpt-4o</option>
          </select>
        </div>
      </details>
      <div class="row" style="gap:8px;margin-top:8px">
        <button id="btnGenSubAI" class="primary">Unteraufgaben generieren</button>
        <button id="btnCloseSubAI" class="danger">Abbrechen</button>
        <span id="subAIBusy" class="muted" style="margin-left:auto"></span>
      </div>
    </form>
  </dialog>

  <!-- Import -->
  <dialog id="dlgImport">
    <form method="dialog" class="card" style="border:none;box-shadow:none">
      <h3 style="margin:0 0 10px">Daten importieren</h3>
      <p class="muted">F√ºge hier den exportierten JSON-Text ein.</p>
      <textarea id="importData" rows="12" placeholder="JSON-Daten hier einf√ºgen‚Ä¶"></textarea>
      <div class="row" style="gap:8px;margin-top:8px">
        <button id="btnDoImport" class="warn">Importieren & √úberschreiben</button>
        <button id="btnCloseImport" class="danger">Abbrechen</button>
      </div>
    </form>
  </dialog>

  <!-- Statistiken -->
  <dialog id="dlgStats">
    <form method="dialog" class="card" style="border:none;box-shadow:none">
      <h3 style="margin:0 0 10px">Statistiken</h3>
      <div id="statsBody"></div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="btnCloseStats" class="danger">Schlie√üen</button>
      </div>
    </form>
  </dialog>

  <!-- Lineal / Tagesansicht Dialog -->
  <dialog id="dlgLineal">
    <form method="dialog" class="card lineal-wrapper" style="border:none;box-shadow:none;padding:12px">
      <h3 style="margin:0 0 10px">Tages-Plan (0:00 ‚Äî 24:00)</h3>
      <div id="linealContainer" class="lineal-container" aria-label="Tages-Plan">
        <div id="linealInner" class="lineal-inner"></div>
      </div>

      <div class="lineal-controls">
        <!-- @-Button: f√ºgt verbleibende Timeline-Wartezeit als Block ein -->
        <button id="btnAddTimelineBlock" class="small primary" title="@ - verbleibende Timeline-Wartezeit einf√ºgen">@ Timeline</button>
        <button id="btnRemoveTimelineBlock" class="small" title="Timeline-Block entfernen">‚úñ Entfernen</button>
        <button id="btnCloseLineal" class="small danger">Schlie√üen</button>
      </div>
    </form>
  </dialog>

  <script>
    // -----------------------------
    // Utilities
    // -----------------------------
    const STORAGE_KEY = '@TodoApp:state';
    const $ = (id)=>document.getElementById(id);
    const rndHue = ()=>Math.floor(Math.random()*360);
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

    // -----------------------------
    // State
    // -----------------------------
    const state = {
      isAppLoading: true,
      settings: { prioritiesEnabled:true, timelineEnabled:true, aiEnabled:true },
      coins: 3,
      todos: [],
      selectedTaskIndex: null,
      timelineTasks: [],
      currentTimelineIndex: 0,
      isTimelineRunning: false,
      timeLeft: 0, // Sekunden verbleibend f√ºr aktuellen Timeline-Task
      categories: {},

      // UI form helpers
      showAddForm: false,
      taskPriority: 'mittel',

      // Lineal-specific
      linealTimelineBlock: null // { startMin: float, endMin: float } in Minuten (0..1440)
    };

    // -----------------------------
    // Persistence
    // -----------------------------
    function saveState(){
      const s = {
        todos: state.todos,
        settings: state.settings,
        coins: state.coins,
        timelineTasks: state.timelineTasks,
        categories: state.categories,
        linealTimelineBlock: state.linealTimelineBlock
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s.todos) state.todos = s.todos;
        if(s.settings) state.settings = s.settings;
        if(typeof s.coins === 'number') state.coins = s.coins;
        if(s.timelineTasks) state.timelineTasks = s.timelineTasks;
        if(s.categories) state.categories = s.categories;
        if(s.linealTimelineBlock) state.linealTimelineBlock = s.linealTimelineBlock;
      }catch(err){ console.error('Load failed', err); }
    }

    // -----------------------------
    // Category colors
    // -----------------------------
    function getCatColor(name){
      const key = (name||'Ohne Kategorie').trim() || 'Ohne Kategorie';
      if(state.categories[key]) return state.categories[key];
      const c = `hsl(${rndHue()},70%,52%)`;
      state.categories[key]=c;
      return c;
    }
    function cleanCategories(maybeTodos){
      const active={};
      const src = maybeTodos || state.todos;
      src.forEach(t=>{
        const cat=(t.category||'Ohne Kategorie').trim()||'Ohne Kategorie';
        active[cat]=state.categories[cat]||getCatColor(cat);
      });
      state.categories = active;
    }

    // -----------------------------
    // Rendering
    // -----------------------------
    function render(){
      $('coinLabel').textContent = `üí∞ ${state.coins}`;
      $('aiArea').style.display = (state.settings.aiEnabled ? '' : 'none');
      $('aiInfo').textContent = state.settings.aiEnabled && state.coins===0
        ? 'Keine Coins mehr. Kaufe neue in den Einstellungen.' : '';

      // Add form toggle
      $('collapsedAdd').style.display = state.showAddForm ? 'none' : '';
      $('expandedAdd').style.display = state.showAddForm ? '' : 'none';
      $('prioRow').style.display = state.settings.prioritiesEnabled && state.showAddForm ? '' : 'none';
      $('prioSel').textContent = `aktuell: ${state.taskPriority}`;

      // Ensure prio buttons reflect selected priority (class prio-selected)
      document.querySelectorAll('#prioRow button[data-prio]').forEach(b=>{
        if(b.getAttribute('data-prio') === state.taskPriority) b.classList.add('prio-selected');
        else b.classList.remove('prio-selected');
      });

      // Selected subtask area
      if(state.selectedTaskIndex!==null){
        $('subtaskArea').style.display = '';
        $('subtaskFor').textContent = state.todos[state.selectedTaskIndex]?.text || '';
      }else{
        $('subtaskArea').style.display = 'none';
      }

      // List
      const list = $('todoList');
      list.innerHTML='';
      state.todos.forEach((item, index)=>{
        const wrap = document.createElement('div'); wrap.className = 'task'+(item.done?' done':'');
        // row
        const row = document.createElement('div'); row.className='row between';
        const left = document.createElement('div'); left.style.flex='1';

        const title = document.createElement('div'); title.className='title';
        const doneBox = document.createElement('input'); doneBox.type='checkbox'; doneBox.checked=item.done;
        doneBox.addEventListener('change',()=>{ item.done = !item.done; saveAndRender(); });

        // editable duration
        const durSpan = document.createElement('span');
        const durLink = document.createElement('a'); durLink.href='#'; durLink.textContent = `${item.duration||5} Min`;
        durLink.style.textDecoration='underline'; durLink.style.color='#0a66c2';
        durLink.addEventListener('click',(e)=>{
          e.preventDefault();
          const v = prompt('Neue Dauer (Minuten):', String(item.duration||5));
          if(v===null) return;
          const n = parseInt(v,10);
          if(!Number.isNaN(n) && n>0){ item.duration = n; saveAndRender(); }
        });

        title.append(doneBox, document.createTextNode(' '));
        const pr = `[${item.priority||'mittel'}] `;
        title.append(document.createTextNode(pr+item.text+' ('), durLink, document.createTextNode(')'));

        // Neu: Falls Zeit vorhanden, anzeigen (z. B. ‚è∞ 09:30)
        if(item.time){
          title.append(document.createTextNode(` ‚è∞ ${item.time}`));
        }

        left.appendChild(title);

        const catRow = document.createElement('div'); catRow.className='kbadge';
        const box = document.createElement('span'); box.className='kbox'; box.style.background=item.color||getCatColor(item.category);
        const ctext = document.createElement('strong'); ctext.textContent = ' ' + (item.category||'Ohne Kategorie');
        catRow.append(box, ctext);
        left.appendChild(catRow);

        const actions = document.createElement('div'); actions.className='actions';
        if(state.settings.aiEnabled && state.coins>0){
          const brain = document.createElement('button'); brain.textContent='üß†'; brain.title='KI-Unteraufgaben';
          brain.addEventListener('click',()=>{
            subAIIndex = index;
            $('subAITitle').textContent = item.text;
            $('dlgSubAI').showModal();
          });
          actions.appendChild(brain);
        }

        const plus = document.createElement('button'); plus.textContent='‚úö';
        plus.addEventListener('click',()=>{
          state.selectedTaskIndex = (state.selectedTaskIndex===index ? null : index);
          render();
        });

        const trash = document.createElement('button'); trash.textContent='üóëÔ∏è';
        trash.addEventListener('click',()=>{ state.todos.splice(index,1); if(state.selectedTaskIndex===index) state.selectedTaskIndex=null; cleanCategories(); saveAndRender(); });

        const cal = document.createElement('button'); cal.textContent='üìÖ';
        cal.addEventListener('click',()=> addToTimeline(index));

        actions.append(plus, trash, cal);
        row.append(left, actions);
        wrap.appendChild(row);

        // subtasks
        if(item.subtasks && item.subtasks.length){
          const stWrap = document.createElement('div'); stWrap.className='subtasks';
          item.subtasks.forEach((s, subIndex)=>{
            const r = document.createElement('div'); r.className='subrow';
            const l = document.createElement('div');
            const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!s.done;
            cb.addEventListener('change',()=>{ s.done=!s.done; saveAndRender(); });
            const t = document.createElement('span'); t.textContent = ' ' + s.text; if(s.done){ t.style.textDecoration='line-through'; t.style.color='#777'; }
            l.append(cb,t);
            const del = document.createElement('button'); del.textContent='üóëÔ∏è';
            del.addEventListener('click',()=>{ item.subtasks.splice(subIndex,1); saveAndRender(); });
            r.append(l,del);
            stWrap.appendChild(r);
          });
          wrap.appendChild(stWrap);
        }
        list.appendChild(wrap);
      });

      // Timeline
      $('timelineArea').style.display = (state.settings.timelineEnabled && state.timelineTasks.length)?'':'none';
      const tl = $('timelineList'); tl.innerHTML='';
      state.timelineTasks.forEach((t,i)=>{
        const row = document.createElement('div'); row.className='section';
        row.innerHTML = `<div>${t.text}</div>`;
        if(i===state.currentTimelineIndex){
          const p = document.createElement('div'); p.className='progress';
          const b = document.createElement('div'); b.className='bar';
          const denom = Math.max(1,(t.duration||5)*60);
          b.style.width = ((state.timeLeft/denom)*100)+'%';
          p.appendChild(b);
          row.appendChild(p);
          const label = document.createElement('div'); label.style.color='#0a66c2'; label.style.fontWeight='700';
          label.textContent = `‚è≥ ${formatTime(state.timeLeft)} verbleibend`;
          row.appendChild(label);
        }
        tl.appendChild(row);
      });

      // Settings switches
      $('swPrio').checked = !!state.settings.prioritiesEnabled;
      $('swTimeline').checked = !!state.settings.timelineEnabled;
      $('swAI').checked = !!state.settings.aiEnabled;

      saveState();
    }
    function saveAndRender(){ saveState(); render(); }

    // -----------------------------
    // Add form handlers
    // -----------------------------
    $('btnShowAdd').addEventListener('click',()=>{ state.showAddForm=true; render(); });

    $('btnCancelAdd').addEventListener('click',()=>{
      state.showAddForm=false;
      $('inpTask').value=''; $('inpDuration').value=''; $('inpCategory').value=''; $('inpCategoryCustom').value=''; $('inpCategoryCustom').style.display='none';
      $('inpTime').value='';
      state.taskPriority='mittel';
      render();
    });

    // Priorit√§ts-Buttons: beim Klick Auswahl setzen + visuelle Markierung
    document.querySelectorAll('#prioRow button[data-prio]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        state.taskPriority = btn.getAttribute('data-prio');
        // entferne alte Markierung, setze neue
        document.querySelectorAll('#prioRow button[data-prio]').forEach(b=>b.classList.remove('prio-selected'));
        btn.classList.add('prio-selected');
        render();
      });
    });

    // Kategorie dropdown: zeige/verstecke custom input
    $('inpCategory').addEventListener('change',()=>{
      if($('inpCategory').value==='custom'){
        $('inpCategoryCustom').style.display='';
        $('inpCategoryCustom').focus();
      }else{
        $('inpCategoryCustom').style.display='none';
        $('inpCategoryCustom').value='';
      }
    });

    $('btnAdd').addEventListener('click',()=>{
      const text = $('inpTask').value.trim();
      if(!text){ alert('Bitte gib eine Hauptaufgabe ein.'); return; }
      const duration = parseInt(($('inpDuration').value||'').trim(),10);

      // Kategorie: wenn 'custom' gew√§hlt, verwende inpCategoryCustom
      let category = ($('inpCategory').value||'').trim();
      if(category==='custom'){
        category = ($('inpCategoryCustom').value||'Ohne Kategorie').trim() || 'Ohne Kategorie';
      }else if(!category){
        category = 'Ohne Kategorie';
      }

      const color = getCatColor(category);

      // Zeitfeld (optional)
      const time = ($('inpTime').value||'').trim();
      const newTodo = {
        text, done:false, subtasks:[],
        duration: Number.isFinite(duration) && duration>0 ? duration : 5,
        priority: state.taskPriority, category, color,
        time: time || null
      };
      const order = { hoch:1, mittel:2, niedrig:3 };
      const next = [...state.todos, newTodo].sort((a,b)=>(order[a.priority||'mittel']||2)-(order[b.priority||'mittel']||2));
      state.todos = next; cleanCategories(next);
      // Reset form fields
      $('inpTask').value=''; $('inpDuration').value=''; $('inpCategory').value=''; $('inpCategoryCustom').value=''; $('inpCategoryCustom').style.display='none';
      $('inpTime').value='';
      state.taskPriority='mittel'; state.showAddForm=false;
      saveAndRender();
    });

    // Subtasks add
    $('btnAddSubtask').addEventListener('click',()=>{
      const idx = state.selectedTaskIndex;
      const text = $('inpSubtask').value.trim();
      if(idx===null || !text) return;
      const t = state.todos[idx]; t.subtasks = Array.isArray(t.subtasks)?t.subtasks:[];
      t.subtasks.push({text, done:false});
      $('inpSubtask').value=''; saveAndRender();
    });

    // -----------------------------
    // Timeline logic
    // -----------------------------
    let timerId = null;
    function tick(){
      if(!state.isTimelineRunning) return;
      if(state.timeLeft>0){
        state.timeLeft -= 1;
        render();
      }else{
        const next = state.currentTimelineIndex + 1;
        if(next < state.timelineTasks.length){
          state.currentTimelineIndex = next;
          state.timeLeft = (state.timelineTasks[next].duration||5)*60;
          render();
        }else{
          state.isTimelineRunning=false;
          state.currentTimelineIndex=0;
          state.timeLeft=0;
          alert('Timeline abgeschlossen');
          render();
        }
      }
    }
    function ensureTimer(){
      if(timerId!==null) clearInterval(timerId);
      timerId = setInterval(tick,1000);
    }
    ensureTimer();

    function addToTimeline(index){
      const task = state.todos[index];
      if(task.duration && task.duration>0){
        state.timelineTasks.push(task);
        saveAndRender();
      }else{
        alert('Diese Aufgabe hat keine g√ºltige Dauer.');
      }
    }
    $('btnToggleTimeline').addEventListener('click',()=>{
      if(state.timelineTasks.length===0) return;
      if(!state.isTimelineRunning){
        if(state.timeLeft===0){
          state.currentTimelineIndex=0;
          state.timeLeft=(state.timelineTasks[0].duration||5)*60;
        }
      }
      state.isTimelineRunning = !state.isTimelineRunning;
      $('btnToggleTimeline').textContent = state.isTimelineRunning ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Start';
      render();
    });
    $('btnClearTimeline').addEventListener('click',()=>{
      state.timelineTasks=[]; state.currentTimelineIndex=0; state.isTimelineRunning=false; state.timeLeft=0; saveAndRender();
    });

    function formatTime(sec){
      const m = Math.floor(sec/60); const s = sec%60;
      return `${m}:${String(s).padStart(2,'0')}`;
    }

    // -----------------------------
    // Settings & Import/Export
    // -----------------------------
    $('btnSettings').addEventListener('click',()=> $('dlgSettings').showModal());
    $('btnCloseSettings').addEventListener('click',()=> $('dlgSettings').close());
    $('swPrio').addEventListener('change',e=>{ state.settings.prioritiesEnabled = e.target.checked; saveAndRender(); });
    $('swTimeline').addEventListener('change',e=>{ state.settings.timelineEnabled = e.target.checked; saveAndRender(); });
    $('swAI').addEventListener('change',e=>{
      if(!e.target.checked){
        state.settings.aiEnabled=false; saveAndRender(); return;
      }
      if(state.coins>0){ state.settings.aiEnabled=true; saveAndRender(); }
      else{
        alert('Du ben√∂tigst Coins, um das KI-Feature zu aktivieren.');
        e.target.checked=false;
      }
    });
    $('btnBuyCoins').addEventListener('click',()=>{ state.coins += 100; alert('100 Coins wurden deinem Konto hinzugef√ºgt.'); saveAndRender(); });

    // Export: speichert JSON in Datei
    $('btnExport').addEventListener('click',(e)=>{
      e.preventDefault();
      const payload = {
        version:1.0,
        exportedAt:new Date().toISOString(),
        data:{
          todos:state.todos, settings:state.settings, coins:state.coins, timelineTasks:state.timelineTasks, categories:state.categories, linealTimelineBlock: state.linealTimelineBlock
        }
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='todo-backup.json'; a.click();
      URL.revokeObjectURL(url);
    });

    $('btnImport').addEventListener('click',(e)=>{ e.preventDefault(); $('dlgImport').showModal(); });
    $('btnCloseImport').addEventListener('click',()=> $('dlgImport').close());
    $('btnDoImport').addEventListener('click',(e)=>{
      e.preventDefault();
      try{
        const parsed = JSON.parse($('importData').value||'{}');
        if(!parsed.data || !parsed.data.todos || !parsed.data.settings) throw new Error('Ung√ºltiges Datenformat');
        state.todos = parsed.data.todos;
        state.settings = parsed.data.settings;
        state.coins = parsed.data.coins||0;
        state.timelineTasks = parsed.data.timelineTasks||[];
        state.categories = parsed.data.categories||{};
        state.linealTimelineBlock = parsed.data.linealTimelineBlock || null;
        cleanCategories();
        alert('Die Daten wurden erfolgreich importiert.');
        $('dlgImport').close(); $('importData').value='';
        saveAndRender();
      }catch(err){
        alert('Import fehlgeschlagen: '+err.message);
      }
    });

    // -----------------------------
    // Stats
    // -----------------------------
    $('btnStats').addEventListener('click',()=>{ buildStats(); $('dlgStats').showModal(); });
    $('btnCloseStats').addEventListener('click',()=> $('dlgStats').close());

    function calculateStats(){
      let doneTime=0, todoTime=0;
      const categoryTime={};
      state.todos.forEach(task=>{
        const t = Number.isFinite(task.duration)?task.duration:0;
        if(task.done) doneTime+=t; else todoTime+=t;
        const cat=(task.category||'Ohne Kategorie').trim()||'Ohne Kategorie';
        categoryTime[cat]=(categoryTime[cat]||0)+t;
      });
      const total = Object.values(categoryTime).reduce((a,b)=>a+b,0)||1;
      const categoryPercentages = Object.entries(categoryTime).map(([cat,time])=>({
        category:cat, time, percent:(time/total)*100, color:state.categories[cat]||getCatColor(cat)
      })).sort((a,b)=>b.percent-a.percent);
      return {doneTime,todoTime,categoryPercentages};
    }
    function buildStats(){
      const {doneTime,todoTime,categoryPercentages}=calculateStats();
      const root = $('statsBody'); root.innerHTML='';
      const t1 = document.createElement('div'); t1.innerHTML=`‚è≥ Kumulierte Zeit unerledigt: <strong>${Math.round(todoTime)} Min</strong>`;
      const t2 = document.createElement('div'); t2.style.marginBottom='10px'; t2.innerHTML=`‚≠ê Kumulierte Zeit erledigt: <strong>${Math.round(doneTime)} Min</strong>`;
      root.append(t1,t2);

      const label = document.createElement('div'); label.style.fontWeight='600'; label.style.marginBottom='6px';
      label.textContent='Zeitverteilung (nach Dauer in Minuten) ‚Äî farbiger Balken:';
      root.appendChild(label);

      const bar = document.createElement('div'); bar.className='percentbar';
      if(!categoryPercentages.length){
        const empty = document.createElement('div'); empty.style.flex='1'; empty.style.display='flex'; empty.style.justifyContent='center'; empty.style.alignItems='center'; empty.textContent='Keine Aufgaben';
        bar.appendChild(empty);
      }else{
        categoryPercentages.forEach(c=>{
          const seg = document.createElement('div'); seg.style.width = c.percent.toFixed(5)+'%'; seg.style.background = c.color;
          bar.appendChild(seg);
        });
      }
      root.appendChild(bar);

      categoryPercentages.forEach(c=>{
        const row = document.createElement('div'); row.className='row'; row.style.marginTop='6px';
        const dot = document.createElement('span'); dot.className='dot'; dot.style.background=c.color;
        const name = document.createElement('span'); name.style.flex='1'; name.textContent = c.category;
        const val = document.createElement('span'); val.textContent = `${Math.round(c.time)} Min (${c.percent.toFixed(1)}%)`;
        row.append(dot,name,val);
        root.appendChild(row);
      });

      const note = document.createElement('div'); note.className='muted'; note.style.marginTop='10px';
      note.textContent = 'Hinweis: Die Zeitberechnung zieht keine Unteraufgabenzeit ab ‚Äî alle Aufgaben werden mit voller Dauer gez√§hlt.';
      root.appendChild(note);
    }

    // -----------------------------
    // AI (Chat Completions)
    // -----------------------------
    function normalizeFromAI(raw){
      if(typeof raw==='string') return {text:raw,done:false,subtasks:[]};
      return {
        text: raw.text || String(raw),
        done: typeof raw.done==='boolean'?raw.done:false,
        subtasks: Array.isArray(raw.subtasks) ? raw.subtasks.map(s=>typeof s==='string'?{text:s,done:false}:{text:s.text||String(s),done:!!s.done}) : []
      };
    }

    $('btnAIModal').addEventListener('click',()=>{
      if(!state.settings.aiEnabled){ alert('KI-Feature ist deaktiviert.'); return; }
      if(state.coins<=0){ alert('Keine Coins mehr.'); return; }
      $('aiBusy').textContent='';
      $('dlgAI').showModal();
    });
    $('btnCloseAI').addEventListener('click',()=> $('dlgAI').close());

    $('btnGenAI').addEventListener('click',async (e)=>{
      e.preventDefault();
      if(state.coins<=0){ alert('Keine Coins mehr.'); return; }
      const prompt = $('aiPrompt').value.trim();
      const key = $('aiKey').value.trim();
      const model = $('aiModel').value;
      if(!prompt){ alert('Bitte gib eine Eingabe f√ºr die KI ein.'); return; }
      if(!key){ alert('Bitte trage deinen OpenAI API-Key ein.'); return; }
      $('aiBusy').textContent='‚Ä¶l√§dt';
      try{
        const res = await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{'Content-Type':'application/json', 'Authorization':'Bearer '+key},
          body: JSON.stringify({
            model,
            messages:[
              {role:'system', content:'Du bist ein Assistent, der aus Text eine ToDo-Liste mit Haupt- und Unteraufgaben generiert. Antworte ausschlie√ülich mit einem JSON-Array im Format [{text: string, done: false, subtasks: [{text:string, done:false}], priority?: "hoch"|"mittel"|"niedrig", duration?: number, category?: string, time?: string}].'},
              {role:'user', content: prompt}
            ],
            temperature:0.7
          })
        });
        const data = await res.json();
        const jsonString = data?.choices?.[0]?.message?.content || data?.choices?.[0]?.text;
        if(!jsonString) throw new Error('Leere KI-Antwort');
        let parsed = JSON.parse(jsonString);
        if(!Array.isArray(parsed)) throw new Error('Nicht-Array');
        const aiTodos = parsed.map(t=>{
          const n = normalizeFromAI(t);
          n.priority = t.priority || 'mittel';
          n.duration = typeof t.duration==='number' ? t.duration : 5;
          const cname = (t.category||'Ohne Kategorie').trim()||'Ohne Kategorie';
          n.category = cname;
          n.color = state.categories[cname] || getCatColor(cname);
          n.time = t.time || null;
          return n;
        });
        state.coins = Math.max(0, state.coins-1);
        const order = {hoch:1,mittel:2,niedrig:3};
        state.todos = [...state.todos, ...aiTodos].sort((a,b)=>(order[a.priority||'mittel']||2)-(order[b.priority||'mittel']||2));
        cleanCategories();
        $('aiPrompt').value='';
        $('dlgAI').close();
        saveAndRender();
      }catch(err){
        console.error(err);
        alert('Fehler bei der KI-Verarbeitung: '+err.message);
      }finally{
        $('aiBusy').textContent='';
      }
    });

    // Subtask AI
    let subAIIndex = null;
    $('btnCloseSubAI').addEventListener('click',()=>{$('subAIPrompt').value=''; subAIIndex=null; $('dlgSubAI').close();});
    $('btnGenSubAI').addEventListener('click',async (e)=>{
      e.preventDefault();
      if(state.coins<=0){ alert('Keine Coins mehr.'); return; }
      if(subAIIndex===null){ alert('Keine Hauptaufgabe ausgew√§hlt.'); return; }
      const extra = $('subAIPrompt').value.trim();
      const key = $('subAIKey').value.trim();
      const model = $('subAIModel').value;
      if(!key){ alert('Bitte trage deinen OpenAI API-Key ein.'); return; }

      const mainText = state.todos[subAIIndex]?.text || '';
      const userContent = `Zergliede die folgende Hauptaufgabe in sinnvolle, klar formulierte Unteraufgaben.
Hauptaufgabe: "${mainText}".
Zusatzinfo: "${extra}"
Antwort ausschlie√ülich als JSON-Array im Format [{text: string, done: false}].`;

      $('subAIBusy').textContent='‚Ä¶l√§dt';
      try{
        const res = await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
          body: JSON.stringify({
            model,
            messages:[
              {role:'system',content:'Du bist ein Assistent, der eine Aufgabe in sinnvolle Unteraufgaben zergliedert. Antworte ausschlie√ülich als JSON-Array im Format [{text: string, done: false}].'},
              {role:'user',content:userContent}
            ],
            temperature:0.7
          })
        });
        const data = await res.json();
        const jsonString = data?.choices?.[0]?.message?.content || data?.choices?.[0]?.text;
        if(!jsonString) throw new Error('Leere KI-Antwort');
        const parsed = JSON.parse(jsonString);
        if(!Array.isArray(parsed)) throw new Error('Nicht-Array');
        const aiSubs = parsed.map(s=> typeof s==='string' ? {text:s,done:false} : {text:s.text||String(s), done: !!s.done});
        const t = state.todos[subAIIndex]; t.subtasks = Array.isArray(t.subtasks)?t.subtasks:[];
        t.subtasks.push(...aiSubs);
        state.coins = Math.max(0, state.coins-1);
        $('subAIPrompt').value=''; subAIIndex=null; $('dlgSubAI').close();
        saveAndRender();
      }catch(err){
        console.error(err);
        alert('Fehler bei der KI-Verarbeitung: '+err.message);
      }finally{
        $('subAIBusy').textContent='';
      }
    });

    // -----------------------------
    // Lineal / Tagesansicht Implementation
    // -----------------------------
    // Skalierung: PIXELS_PER_MINUTE : wieviel px = 1 Minute. 1px/min ergibt 1440px Gesamt.
    const PIXELS_PER_MIN = 1; // 1px = 1 Minute ‚Üí Gesamth√∂he 1440px
    const TOTAL_MINUTES = 24 * 60;
    function minutesToPx(min){ return min * PIXELS_PER_MIN; }
    function pxToMinutes(px){ return px / PIXELS_PER_MIN; }

    function formatTimeOfDay(mins){
      const h = Math.floor(mins/60)%24;
      const m = Math.floor(mins%60);
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    }

    function renderLineal(){
      const inner = $('linealInner');
      inner.innerHTML = '';
      // Set inner height
      const totalHeight = minutesToPx(TOTAL_MINUTES);
      inner.style.height = totalHeight + 'px';

      // Stundenmarken (0..24)
      for(let h=0; h<=24; h++){
        const minute = h*60;
        const y = minutesToPx(minute);
        const hr = document.createElement('div');
        hr.className='hour-line';
        hr.style.top = y + 'px';
        hr.style.background = (h%6===0) ? '#d9d9d9' : '#eee';
        inner.appendChild(hr);

        if(h<24){
          const label = document.createElement('div');
          label.className='hour-label';
          label.style.top = y + 'px';
          label.textContent = `${String(h).padStart(2,'0')}:00`;
          inner.appendChild(label);
        }
      }

      // Aufgaben mit Zeit -> Bl√∂cke rendern
      state.todos.forEach(task=>{
        if(!task.time) return;
        const parts = task.time.split(':').map(s=>parseInt(s,10));
        if(parts.length<2 || Number.isNaN(parts[0]) || Number.isNaN(parts[1])) return;
        const startMin = clamp(parts[0]*60 + parts[1], 0, TOTAL_MINUTES);
        const dur = Number.isFinite(task.duration) && task.duration>0 ? task.duration : 5;
        const endMin = clamp(startMin + dur, 0, TOTAL_MINUTES);

        // Create block
        const block = document.createElement('div');
        block.className = 'lineal-block';
        block.style.top = minutesToPx(startMin) + 'px';
        block.style.height = Math.max(8, minutesToPx(endMin - startMin)) + 'px'; // min height for visibility
        block.style.background = task.color || getCatColor(task.category);
        block.textContent = task.text;
        block.title = `${task.text} ‚Äî ${formatTimeOfDay(startMin)} ‚Üí ${formatTimeOfDay(endMin)} (${dur} Min)`;
        inner.appendChild(block);
      });

      // Timeline-Block falls vorhanden
      if(state.linealTimelineBlock){
        const b = state.linealTimelineBlock;
        const startMin = clamp(b.startMin, 0, TOTAL_MINUTES);
        const endMin = clamp(b.endMin, 0, TOTAL_MINUTES);
        if(endMin > startMin){
          const tblock = document.createElement('div');
          tblock.className = 'lineal-timeline-block';
          tblock.style.top = minutesToPx(startMin) + 'px';
          tblock.style.height = Math.max(10, minutesToPx(endMin - startMin)) + 'px';
          tblock.textContent = `Timeline ‚Äî ${formatTimeOfDay(startMin)} ‚Üí ${formatTimeOfDay(endMin)} (${Math.round((endMin-startMin))} Min)`;
          tblock.title = `Timeline: ${formatTimeOfDay(startMin)} - ${formatTimeOfDay(endMin)}`;
          inner.appendChild(tblock);
        }
      }

      // Zeitmarker (aktuelle Zeit)
      const now = new Date();
      const nowMin = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
      const marker = document.createElement('div');
      marker.className = 'time-marker';
      marker.style.top = minutesToPx(nowMin) + 'px';
      marker.style.height = '4px';
      marker.style.background = 'darkred';
      inner.appendChild(marker);
    }

    // √ñffnen / Schlie√üen Dialog & Interval f√ºr Update
    let linealInterval = null;
    $('btnLineal').addEventListener('click',()=>{
      renderLineal();
      $('dlgLineal').showModal();
      // Scroll to current time (zentriert)
      setTimeout(()=> {
        const container = $('linealContainer');
        const now = new Date();
        const nowMin = now.getHours()*60 + now.getMinutes();
        const targetPx = Math.max(0, minutesToPx(nowMin) - container.clientHeight/2);
        container.scrollTop = targetPx;
      },50);

      // Start regelm√§√üiges Update (jede 15 Sekunden)
      if(linealInterval!==null) clearInterval(linealInterval);
      linealInterval = setInterval(()=>{
        // nur neu rendern, wenn Dialog offen
        if($('dlgLineal').open) renderLineal();
      },15000);
    });
    $('btnCloseLineal').addEventListener('click',()=> {
      $('dlgLineal').close();
      if(linealInterval!==null){ clearInterval(linealInterval); linealInterval=null; }
    });

    // @-Button: verbleibende Zeit der Timeline-Warteschlange summieren und als Block hinzuf√ºgen
    $('btnAddTimelineBlock').addEventListener('click',()=>{
      // Berechne verbleibende Zeit in Sekunden:
      let remainingSeconds = 0;
      if(state.timelineTasks && state.timelineTasks.length>0){
        // Aktuelles Task-Restzeit (in Sekunden)
        remainingSeconds += Number.isFinite(state.timeLeft) ? state.timeLeft : 0;
        // Zeit aller nachfolgenden Tasks (Dauer in Minuten -> *60)
        for(let i = state.currentTimelineIndex + 1; i < state.timelineTasks.length; i++){
          const t = state.timelineTasks[i];
          const d = Number.isFinite(t.duration) ? t.duration : 0;
          remainingSeconds += d * 60;
        }
      }
      if(remainingSeconds <= 0){
        alert('Keine verbleibende Zeit in der Timeline.');
        return;
      }
      const now = new Date();
      const startMin = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
      const endMin = startMin + (remainingSeconds / 60);
      state.linealTimelineBlock = { startMin, endMin };
      saveAndRender();
      renderLineal();
      alert(`Timeline-Block hinzugef√ºgt (${Math.round(remainingSeconds/60)} Min).`);
    });

    $('btnRemoveTimelineBlock').addEventListener('click',()=>{
      state.linealTimelineBlock = null;
      saveAndRender();
      renderLineal();
    });

    // -----------------------------
    // Boot
    // -----------------------------
    loadState();
    cleanCategories();
    render();
  </script>
</body>
</html>
